{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://dashboard.system/widget-contract.schema.json",
  "title": "Widget Contract Schema",
  "description": "Schema para definição de contratos de widgets do sistema de dashboard dinâmico",
  "type": "object",
  "required": ["moduleId", "version", "widgets"],
  "properties": {
    "moduleId": {
      "type": "string",
      "pattern": "^[a-z][a-z0-9-]*[a-z0-9]$",
      "description": "Identificador único do módulo (kebab-case)",
      "examples": ["analytics", "inventory", "performance", "alerts"]
    },
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "Versão semântica do módulo",
      "examples": ["1.0.0", "2.1.3"]
    },
    "description": {
      "type": "string",
      "maxLength": 500,
      "description": "Descrição do módulo e seus widgets"
    },
    "widgets": {
      "type": "array",
      "minItems": 1,
      "description": "Lista de widgets fornecidos pelo módulo",
      "items": {
        "$ref": "#/$defs/Widget"
      }
    },
    "dependencies": {
      "type": "array",
      "description": "Dependências do módulo",
      "items": {
        "type": "object",
        "required": ["moduleId", "minVersion"],
        "properties": {
          "moduleId": {
            "type": "string"
          },
          "minVersion": {
            "type": "string",
            "pattern": "^\\d+\\.\\d+\\.\\d+$"
          }
        }
      }
    }
  },
  "$defs": {
    "Widget": {
      "type": "object",
      "required": ["id", "title", "componentPath", "queryConfig"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9-]*[a-z0-9]$",
          "description": "Identificador único do widget dentro do módulo",
          "examples": ["performance-kpis", "sales-overview", "low-stock-alert"]
        },
        "title": {
          "type": "string",
          "minLength": 1,
          "maxLength": 100,
          "description": "Título exibido do widget"
        },
        "description": {
          "type": "string",
          "maxLength": 300,
          "description": "Descrição do widget e funcionalidade"
        },
        "componentPath": {
          "type": "string",
          "pattern": "^/widgets/[a-z0-9-/]+$",
          "description": "Caminho para o componente React do widget",
          "examples": ["/widgets/analytics/performance-kpis", "/widgets/inventory/low-stock"]
        },
        "category": {
          "type": "string",
          "enum": ["analytics", "inventory", "performance", "alerts", "finance", "operations", "reports"],
          "description": "Categoria do widget para organização"
        },
        "tags": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^[a-z0-9-]+$"
          },
          "description": "Tags para busca e categorização",
          "examples": [["kpi", "sales"], ["inventory", "stock"], ["performance", "metrics"]]
        },
        "queryConfig": {
          "$ref": "#/$defs/QueryConfig"
        },
        "defaultParams": {
          "type": "object",
          "description": "Parâmetros padrão do widget",
          "additionalProperties": true
        },
        "defaultSize": {
          "$ref": "#/$defs/WidgetSize"
        },
        "minSize": {
          "$ref": "#/$defs/WidgetSize"
        },
        "maxSize": {
          "$ref": "#/$defs/WidgetSize"
        },
        "resizable": {
          "type": "boolean",
          "default": true,
          "description": "Se o widget pode ser redimensionado"
        },
        "configurable": {
          "type": "boolean",
          "default": true,
          "description": "Se o widget tem configurações personalizáveis"
        },
        "configSchema": {
          "$ref": "#/$defs/ConfigSchema"
        },
        "refreshInterval": {
          "type": "integer",
          "minimum": 30,
          "maximum": 3600,
          "description": "Intervalo de atualização em segundos (30s - 1h)"
        },
        "permissions": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Permissões necessárias para usar o widget",
          "examples": [["analytics:read", "dashboard:view"]]
        },
        "compatibility": {
          "type": "object",
          "properties": {
            "minScreenWidth": {
              "type": "integer",
              "description": "Largura mínima da tela em pixels"
            },
            "mobile": {
              "type": "boolean",
              "description": "Se funciona em dispositivos móveis"
            },
            "clientTypes": {
              "type": "array",
              "items": {
                "type": "string",
                "enum": ["standard", "custom", "banban", "riachuelo", "ca"]
              },
              "description": "Tipos de cliente compatíveis"
            }
          }
        }
      }
    },
    "QueryConfig": {
      "type": "object",
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["rpc", "rest", "sql"],
          "description": "Tipo da query"
        }
      },
      "oneOf": [
        {
          "properties": {
            "type": { "const": "rpc" },
            "function": {
              "type": "string",
              "description": "Nome da função RPC no Supabase"
            },
            "params": {
              "type": "object",
              "description": "Parâmetros padrão da função"
            }
          },
          "required": ["function"]
        },
        {
          "properties": {
            "type": { "const": "rest" },
            "endpoint": {
              "type": "string",
              "format": "uri",
              "description": "URL do endpoint REST"
            },
            "method": {
              "type": "string",
              "enum": ["GET", "POST"],
              "default": "GET"
            },
            "headers": {
              "type": "object",
              "description": "Headers HTTP customizados"
            },
            "params": {
              "type": "object",
              "description": "Parâmetros da requisição"
            }
          },
          "required": ["endpoint"]
        },
        {
          "properties": {
            "type": { "const": "sql" },
            "query": {
              "type": "string",
              "description": "Query SQL parametrizada"
            },
            "params": {
              "type": "object",
              "description": "Parâmetros da query SQL"
            }
          },
          "required": ["query"]
        }
      ]
    },
    "WidgetSize": {
      "type": "object",
      "required": ["width", "height"],
      "properties": {
        "width": {
          "type": "integer",
          "minimum": 1,
          "maximum": 12,
          "description": "Largura em colunas do grid (1-12)"
        },
        "height": {
          "type": "integer",
          "minimum": 1,
          "maximum": 20,
          "description": "Altura em unidades do grid"
        }
      }
    },
    "ConfigSchema": {
      "type": "object",
      "description": "Schema JSON para configurações do widget",
      "properties": {
        "type": {
          "const": "object"
        },
        "properties": {
          "type": "object",
          "additionalProperties": {
            "type": "object",
            "properties": {
              "type": {
                "type": "string",
                "enum": ["string", "number", "boolean", "array", "object"]
              },
              "title": {
                "type": "string",
                "description": "Título do campo de configuração"
              },
              "description": {
                "type": "string",
                "description": "Descrição do campo"
              },
              "default": {
                "description": "Valor padrão"
              },
              "enum": {
                "type": "array",
                "description": "Valores possíveis para select"
              },
              "minimum": {
                "type": "number",
                "description": "Valor mínimo para números"
              },
              "maximum": {
                "type": "number",
                "description": "Valor máximo para números"
              }
            },
            "required": ["type", "title"]
          }
        },
        "required": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    }
  }
}