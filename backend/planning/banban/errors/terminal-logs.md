✓ Starting...
 ✓ Ready in 2.8s
 ✓ Compiled /middleware in 346ms (200 modules)
🌐 Middleware executado para: /login
 ○ Compiling /login ...
 ✓ Compiled /login in 6.5s (1300 modules)
 ✓ Compiled in 634ms (482 modules)
🌐 Middleware executado para: /_next/static/css/app/layout.css
🌐 Middleware executado para: /_next/static/css/app/(public)/login/layout.css
🌐 Middleware executado para: /_next/static/chunks/webpack.js
🌐 Middleware executado para: /_next/static/chunks/main-app.js
🌐 Middleware executado para: /_next/static/chunks/app-pages-internals.js
 GET /login 200 in 7905ms
 ✓ Compiled in 704ms (454 modules)
🌐 Middleware executado para: /_next/static/chunks/app/error.js
🌐 Middleware executado para: /_next/static/chunks/app/layout.js
🌐 Middleware executado para: /_next/static/chunks/app/(public)/login/page.js
🌐 Middleware executado para: /_next/static/chunks/app/not-found.js
🌐 Middleware executado para: /_next/static/chunks/app/global-error.js
🌐 Middleware executado para: /_next/static/chunks/_app-pages-browser_node_modules_next_dist_client_dev_noop-turbopack-hmr_js.js
🌐 Middleware executado para: /login
 POST /login 200 in 626ms
🌐 Middleware executado para: /admin/audit
🔍 Verificando bloqueio para usuário d5edd63c-1497-4925-a649-d348440d142b na rota /admin/audit
🔍 Resultado do bloqueio para d5edd63c-1497-4925-a649-d348440d142b: false
 ○ Compiling /admin/audit ...
 ✓ Compiled /admin/audit in 3.5s (3630 modules)
🌐 Middleware executado para: /_next/static/webpack/55e70880ff7da3ae.webpack.hot-update.json
🌐 Middleware executado para: /_next/static/webpack/webpack.55e70880ff7da3ae.hot-update.js
 GET /admin/audit 200 in 4204ms
🌐 Middleware executado para: /_next/static/css/app/layout.css
🌐 Middleware executado para: /_next/static/chunks/webpack.js
🌐 Middleware executado para: /_next/static/chunks/main-app.js
🌐 Middleware executado para: /_next/static/chunks/app-pages-internals.js
🌐 Middleware executado para: /_next/static/chunks/app/layout.js
🌐 Middleware executado para: /_next/static/chunks/app/error.js
🌐 Middleware executado para: /_next/static/chunks/app/not-found.js
🌐 Middleware executado para: /_next/static/chunks/app/(protected)/admin/layout.js
🌐 Middleware executado para: /_next/static/chunks/app/(protected)/admin/audit/page.js
🌐 Middleware executado para: /_next/static/chunks/app/global-error.js
🌐 Middleware executado para: /_next/static/chunks/app/(protected)/layout.js
🌐 Middleware executado para: /admin/audit
🌐 Middleware executado para: /_next/static/chunks/_app-pages-browser_node_modules_next_dist_client_dev_noop-turbopack-hmr_js.js
🔍 Verificando bloqueio para usuário d5edd63c-1497-4925-a649-d348440d142b na rota /admin/audit
🔍 Resultado do bloqueio para d5edd63c-1497-4925-a649-d348440d142b: false
Using the user object as returned from supabase.auth.getSession() or from some supabase.auth.onAuthStateChange() events could be insecure! This value comes directly from the storage medium (usually cookies on the server) and may not be authentic. Use supabase.auth.getUser() instead which authenticates the data by contacting the Supabase Auth server.
 POST /admin/audit 200 in 198ms
🌐 Middleware executado para: /admin/audit
🌐 Middleware executado para: /api/system/maintenance-status
🔍 Verificando bloqueio para usuário d5edd63c-1497-4925-a649-d348440d142b na rota /admin/audit
🔍 Resultado do bloqueio para d5edd63c-1497-4925-a649-d348440d142b: false
 ○ Compiling /api/system/maintenance-status ...
 ✓ Compiled /api/system/maintenance-status in 864ms (3657 modules)
🌐 Middleware executado para: /_next/static/webpack/7db4236f035954b5.webpack.hot-update.json
🌐 Middleware executado para: /_next/static/webpack/7db4236f035954b5.webpack.hot-update.json
🌐 Middleware executado para: /_next/static/webpack/webpack.7db4236f035954b5.hot-update.js
🌐 Middleware executado para: /_next/static/webpack/webpack.7db4236f035954b5.hot-update.js
 GET /api/system/maintenance-status 200 in 1241ms
🌐 Middleware executado para: /api/system/maintenance-status
 GET /api/system/maintenance-status 200 in 51ms
 POST /admin/audit 200 in 359ms
🌐 Middleware executado para: /admin/audit
🔍 Verificando bloqueio para usuário d5edd63c-1497-4925-a649-d348440d142b na rota /admin/audit
🔍 Resultado do bloqueio para d5edd63c-1497-4925-a649-d348440d142b: false
 POST /admin/audit 200 in 329ms
🌐 Middleware executado para: /admin/audit
🔍 Verificando bloqueio para usuário d5edd63c-1497-4925-a649-d348440d142b na rota /admin/audit
🔍 Resultado do bloqueio para d5edd63c-1497-4925-a649-d348440d142b: false
 POST /admin/audit 200 in 295ms
🌐 Middleware executado para: /admin/audit
🔍 Verificando bloqueio para usuário d5edd63c-1497-4925-a649-d348440d142b na rota /admin/audit
🔍 Resultado do bloqueio para d5edd63c-1497-4925-a649-d348440d142b: false
 POST /admin/audit 200 in 291ms
🌐 Middleware executado para: /admin/audit
🔍 Verificando bloqueio para usuário d5edd63c-1497-4925-a649-d348440d142b na rota /admin/audit
🔍 Resultado do bloqueio para d5edd63c-1497-4925-a649-d348440d142b: false
 POST /admin/audit 200 in 328ms
🌐 Middleware executado para: /admin/audit
🔍 Verificando bloqueio para usuário d5edd63c-1497-4925-a649-d348440d142b na rota /admin/audit
🔍 Resultado do bloqueio para d5edd63c-1497-4925-a649-d348440d142b: false
 POST /admin/audit 200 in 367ms
🌐 Middleware executado para: /admin/audit
🔍 Verificando bloqueio para usuário d5edd63c-1497-4925-a649-d348440d142b na rota /admin/audit
🔍 Resultado do bloqueio para d5edd63c-1497-4925-a649-d348440d142b: false
 POST /admin/audit 200 in 334ms
🌐 Middleware executado para: /login
🔍 ServerAction: Verificando bloqueio para usuário: a8919fc9-ec1a-4c59-938d-28d1da2b953f
🔍 ServerAction: Resultado do bloqueio: false
Failed to create audit log: Error: Acesso negado: Apenas master admins podem usar este cliente
    at createSupabaseAdminClient (src\core\supabase\admin.ts:82:10)
    at async createAuditLog (src\features\security\audit-logger.ts:102:21)
    at async signInWithPassword (src\app\actions\auth\login.ts:127:4)
  80 |
  81 |   if (!authorized) {
> 82 |     throw new Error('Acesso negado: Apenas master admins podem usar este cliente');
     |          ^
  83 |   }
  84 |
  85 |   if (!supabaseUrl || !supabaseServiceRoleKey) {
 POST /login 200 in 1294ms
🌐 Middleware executado para: /banban-fashion
🔍 Verificando bloqueio para usuário a8919fc9-ec1a-4c59-938d-28d1da2b953f na rota /banban-fashion
🔍 Resultado do bloqueio para a8919fc9-ec1a-4c59-938d-28d1da2b953f: false
 ○ Compiling /[slug] ...
🌐 Middleware executado para: /admin/audit
🔍 Verificando bloqueio para usuário d5edd63c-1497-4925-a649-d348440d142b na rota /admin/audit
🔍 Resultado do bloqueio para d5edd63c-1497-4925-a649-d348440d142b: false
🌐 Middleware executado para: /_next/static/webpack/737fd068ae01bc7a.webpack.hot-update.json
🌐 Middleware executado para: /_next/static/webpack/737fd068ae01bc7a.webpack.hot-update.json
🌐 Middleware executado para: /_next/static/webpack/webpack.737fd068ae01bc7a.hot-update.js
🌐 Middleware executado para: /_next/static/webpack/webpack.737fd068ae01bc7a.hot-update.js
 ✓ Compiled /[slug] in 4.6s (7021 modules)
 POST /admin/audit 200 in 2350ms
🌐 Middleware executado para: /admin/audit
🔍 Verificando bloqueio para usuário d5edd63c-1497-4925-a649-d348440d142b na rota /admin/audit
🔍 Resultado do bloqueio para d5edd63c-1497-4925-a649-d348440d142b: false
🌐 Middleware executado para: /_next/static/chunks/app/(protected)/%5Bslug%5D/layout.js
🌐 Middleware executado para: /_next/static/chunks/app/(protected)/layout.js
🌐 Middleware executado para: /banban-fashion
 GET /banban-fashion 200 in 6267ms
🌐 Middleware executado para: /_next/static/chunks/app/(protected)/%5Bslug%5D/page.js
🔍 Verificando bloqueio para usuário a8919fc9-ec1a-4c59-938d-28d1da2b953f na rota /banban-fashion
🔍 Resultado do bloqueio para a8919fc9-ec1a-4c59-938d-28d1da2b953f: false
 POST /admin/audit 200 in 343ms
🌐 Middleware executado para: /admin/audit
🔍 Verificando bloqueio para usuário d5edd63c-1497-4925-a649-d348440d142b na rota /admin/audit
🔍 Resultado do bloqueio para d5edd63c-1497-4925-a649-d348440d142b: false
🌐 Middleware executado para: /_next/static/css/app/layout.css
🌐 Middleware executado para: /banban-fashion
 GET /banban-fashion 200 in 268ms
🔍 Verificando bloqueio para usuário a8919fc9-ec1a-4c59-938d-28d1da2b953f na rota /banban-fashion
🔍 Resultado do bloqueio para a8919fc9-ec1a-4c59-938d-28d1da2b953f: false
 POST /admin/audit 200 in 282ms
Using the user object as returned from supabase.auth.getSession() or from some supabase.auth.onAuthStateChange() events could be insecure! This value comes directly from the storage medium (usually cookies on the server) and may not be authentic. Use supabase.auth.getUser() instead which authenticates the data by contacting the Supabase Auth server.
 POST /banban-fashion 200 in 77ms
🌐 Middleware executado para: /banban-fashion
🌐 Middleware executado para: /api/system/maintenance-status
 GET /api/system/maintenance-status 200 in 173ms
🔍 Verificando bloqueio para usuário a8919fc9-ec1a-4c59-938d-28d1da2b953f na rota /banban-fashion
🌐 Middleware executado para: /api/system/maintenance-status
 GET /api/system/maintenance-status 200 in 52ms
🔍 Resultado do bloqueio para a8919fc9-ec1a-4c59-938d-28d1da2b953f: false
Using the user object as returned from supabase.auth.getSession() or from some supabase.auth.onAuthStateChange() events could be insecure! This value comes directly from the storage medium (usually cookies on the server) and may not be authentic. Use supabase.auth.getUser() instead which authenticates the data by contacting the Supabase Auth server.
 POST /banban-fashion 200 in 66ms
🌐 Middleware executado para: /banban-fashion
🔍 Verificando bloqueio para usuário a8919fc9-ec1a-4c59-938d-28d1da2b953f na rota /banban-fashion
🔍 Resultado do bloqueio para a8919fc9-ec1a-4c59-938d-28d1da2b953f: false
🌐 Middleware executado para: /banban-fashion
🌐 Middleware executado para: /api/modules/configuration
🌐 Middleware executado para: /api/dashboard/layout
🌐 Middleware executado para: /_next/static/chunks/_app-pages-browser_src_clients_banban_components_index_ts.js
 POST /banban-fashion 200 in 325ms
🔍 Verificando bloqueio para usuário a8919fc9-ec1a-4c59-938d-28d1da2b953f na rota /banban-fashion
🔍 Resultado do bloqueio para a8919fc9-ec1a-4c59-938d-28d1da2b953f: false
 ○ Compiling /api/dashboard/layout ...
🌐 Middleware executado para: /_next/static/webpack/db569fea6ad3da1b.webpack.hot-update.json
🌐 Middleware executado para: /_next/static/webpack/db569fea6ad3da1b.webpack.hot-update.json
🌐 Middleware executado para: /_next/static/webpack/webpack.db569fea6ad3da1b.hot-update.js
🌐 Middleware executado para: /_next/static/webpack/webpack.db569fea6ad3da1b.hot-update.js
🌐 Middleware executado para: /_next/static/webpack/084ce94d7ae3fc55.webpack.hot-update.json
🌐 Middleware executado para: /_next/static/webpack/084ce94d7ae3fc55.webpack.hot-update.json
🌐 Middleware executado para: /_next/static/webpack/webpack.084ce94d7ae3fc55.hot-update.js
🌐 Middleware executado para: /_next/static/webpack/webpack.084ce94d7ae3fc55.hot-update.js
 ✓ Compiled /api/dashboard/layout in 3.4s (7026 modules)
[ModuleConfigurationService] Carregando módulos para organização: 2da2a9a7-89ec-48bf-a3bc-c46e58d5a9b4
[ModuleConfigurationService] Query executada. Error: null
[ModuleConfigurationService] Raw modules: 3
[ModuleConfigurationService] 3 módulos carregados com a nova arquitetura
 GET /api/modules/configuration?organizationId=2da2a9a7-89ec-48bf-a3bc-c46e58d5a9b4 200 in 3906ms
🌐 Middleware executado para: /api/modules/configuration
 GET /api/dashboard/layout?tenant_id=2da2a9a7-89ec-48bf-a3bc-c46e58d5a9b4 200 in 3983ms
🌐 Middleware executado para: /_next/static/css/app/layout.css
🌐 Middleware executado para: /api/dashboard/layout
 POST /banban-fashion 200 in 2539ms
[ModuleConfigurationService] Carregando módulos para organização: 2da2a9a7-89ec-48bf-a3bc-c46e58d5a9b4
[ModuleConfigurationService] Query executada. Error: null
[ModuleConfigurationService] Raw modules: 3
[ModuleConfigurationService] 3 módulos carregados com a nova arquitetura
 GET /api/modules/configuration?organizationId=2da2a9a7-89ec-48bf-a3bc-c46e58d5a9b4 200 in 514ms
 GET /api/dashboard/layout?tenant_id=2da2a9a7-89ec-48bf-a3bc-c46e58d5a9b4 200 in 523ms
🌐 Middleware executado para: /admin/audit
🔍 Verificando bloqueio para usuário d5edd63c-1497-4925-a649-d348440d142b na rota /admin/audit
🔍 Resultado do bloqueio para d5edd63c-1497-4925-a649-d348440d142b: false
🔄 Tentando encerrar sessão: 4d806c62-f0d3-4dad-86a9-b7bc1b1d0146
👤 Perfil do usuário: { role: 'master_admin', organization_id: null }
🔧 Marcando sessão como inativa
🔧 Invalidando tokens JWT do usuário via RPC: a8919fc9-ec1a-4c59-938d-28d1da2b953f
✅ Tokens JWT removidos via RPC. Resultado: true
🔧 Bloqueando usuário temporariamente: a8919fc9-ec1a-4c59-938d-28d1da2b953f
✅ Usuário bloqueado temporariamente por 10 minutos
🔧 Invalidação adicional via admin API
⚠️ Erro na invalidação admin: Error [AuthApiError]: invalid JWT: unable to parse or verify signature, token is malformed: token contains an invalid number of segments
    at async terminateSession (src\app\(protected)\admin\audit\sessions-actions.ts:267:36)
  265 |     try {
  266 |       // Invalidar todas as sessões JWT do usuário diretamente
> 267 |       const { error: adminError } = await supabase.auth.admin.signOut(targetUserId, 'global')
      |                                    ^
  268 |
  269 |       if (adminError) {
  270 |         console.debug('⚠️ Erro na invalidação admin:', adminError) {
  __isAuthError: true,
  status: 403,
  code: 'bad_jwt'
}
🏷️ Criando marcador de bloqueio no lado do cliente
📡 Informação de bloqueio a ser transmitida: {
  user_id: 'a8919fc9-ec1a-4c59-938d-28d1da2b953f',
  blocked_until: '2025-07-24T20:05:59.696Z',
  reason: 'session_terminated',
  timestamp: 1753386959696
}
✅ Marcador de bloqueio preparado
🗑️ Invalidando caches relacionados ao usuário
✅ Preparação para limpeza de cache concluída
🌐 Middleware executado para: /admin/audit
 POST /admin/audit 200 in 1344ms
🔍 Verificando bloqueio para usuário d5edd63c-1497-4925-a649-d348440d142b na rota /admin/audit
🔍 Resultado do bloqueio para d5edd63c-1497-4925-a649-d348440d142b: false
 POST /admin/audit 200 in 311ms
🌐 Middleware executado para: /admin/audit
🔍 Verificando bloqueio para usuário d5edd63c-1497-4925-a649-d348440d142b na rota /admin/audit
🔍 Resultado do bloqueio para d5edd63c-1497-4925-a649-d348440d142b: false
 POST /admin/audit 200 in 302ms
🌐 Middleware executado para: /admin/audit
🔍 Verificando bloqueio para usuário d5edd63c-1497-4925-a649-d348440d142b na rota /admin/audit
🔍 Resultado do bloqueio para d5edd63c-1497-4925-a649-d348440d142b: false
 POST /admin/audit 200 in 290ms
🌐 Middleware executado para: /_next/static/css/app/layout.css
🌐 Middleware executado para: /banban-fashion/alerts
🔍 Middleware: Usuário não autenticado em /banban-fashion/alerts - verificando bloqueios recentes
🔍 Middleware: Headers de cookie disponíveis: sim
🔍 Middleware: Conteúdo dos cookies (primeiros 200 chars): __next_hmr_refresh_hash__=27ae27b0024674d7f8893f620299203cbc7b4b7cceddff9a; sb-bopytcghbmuywfltmwhk-auth-token=
🔍 Middleware: Padrões Supabase detectados: SIM
🔍 Middleware: Header de terminação: ausente
🔍 Middleware: Detectados cookies Supabase OU header de terminação - buscando usuários recém-bloqueados
🔍 Middleware: IP do cliente: ::1
🔍 Middleware: Buscando bloqueios desde: 2025-07-24T19:26:06.174Z
🔍 Middleware: Bloqueios recentes encontrados: 1, erro: nenhum
🔍 Middleware: Analisando 1 bloqueios recentes
🔍 Middleware: Bloqueio mais recente: usuário a8919fc9-ec1a-4c59-938d-28d1da2b953f, idade: 7s
🔍 Middleware: Tempo restante do bloqueio: 594s
🚫 Middleware: CORRELAÇÃO POSITIVA - usuário recém-bloqueado tentando acesso
🔄 Middleware: Redirecionando com parâmetros para: http://localhost:3000/login?reason=session_terminated&blocked_until=594
🌐 Middleware executado para: /login
 GET /login?reason=session_terminated&blocked_until=594 200 in 66ms
🌐 Middleware executado para: /_next/static/css/app/(public)/login/layout.css
🌐 Middleware executado para: /login
 GET /login 200 in 57ms